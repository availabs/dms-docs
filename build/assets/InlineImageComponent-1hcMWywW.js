import{r as g,j as e,aj as Y,L as H,b as i,a as B,J as F,E as X,F as K}from"./vendor-9mQZ5CO5.js";import{L as U}from"./LexicalNestedComposer-B2QbZ0L1.js";import{u as G,$ as T,L as V,F as J,a as q,b as Q,P as Z,T as ee,S as te,D as ne,B as se}from"./index-m1bSR3mx.js";function $(m,R,u){return Math.min(Math.max(m,R),u)}const s={east:1,north:8,south:2,west:4};function ie({onResizeStart:m,onResizeEnd:R,buttonRef:u,imageRef:S,maxWidth:x,editor:C,showCaption:w,setShowCaption:M,captionsEnabled:L}){const j=g.useRef(null),E=g.useRef({priority:"",value:"default"}),y=g.useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),l=C.getRootElement(),b=x||(l!==null?l.getBoundingClientRect().width-20:100),v=l!==null?l.getBoundingClientRect().height-20:100,c=100,D=100,W=t=>{const o=t===s.east||t===s.west,n=t===s.north||t===s.south,N=t&s.north&&t&s.west||t&s.south&&t&s.east,h=o?"ew":n?"ns":N?"nwse":"nesw";l!==null&&l.style.setProperty("cursor",`${h}-resize`,"important"),document.body!==null&&(document.body.style.setProperty("cursor",`${h}-resize`,"important"),E.current.value=document.body.style.getPropertyValue("-webkit-user-select"),E.current.priority=document.body.style.getPropertyPriority("-webkit-user-select"),document.body.style.setProperty("-webkit-user-select","none","important"))},I=()=>{l!==null&&l.style.setProperty("cursor","text"),document.body!==null&&(document.body.style.setProperty("cursor","default"),document.body.style.setProperty("-webkit-user-select",E.current.value,E.current.priority))},p=(t,o)=>{if(!C.isEditable())return;const n=S.current,N=j.current;if(n!==null&&N!==null){t.preventDefault();const{width:h,height:r}=n.getBoundingClientRect(),a=y.current;a.startWidth=h,a.startHeight=r,a.ratio=h/r,a.currentWidth=h,a.currentHeight=r,a.startX=t.clientX,a.startY=t.clientY,a.isResizing=!0,a.direction=o,W(o),m(),N.classList.add("image-control-wrapper--resizing"),n.style.height=`${r}px`,n.style.width=`${h}px`,document.addEventListener("pointermove",_),document.addEventListener("pointerup",O)}},_=t=>{const o=S.current,n=y.current,N=n.direction&(s.east|s.west),h=n.direction&(s.south|s.north);if(o!==null&&n.isResizing)if(N&&h){let r=Math.floor(n.startX-t.clientX);r=n.direction&s.east?-r:r;const a=$(n.startWidth+r,c,b),z=a/n.ratio;o.style.width=`${a}px`,o.style.height=`${z}px`,n.currentHeight=z,n.currentWidth=a}else if(h){let r=Math.floor(n.startY-t.clientY);r=n.direction&s.south?-r:r;const a=$(n.startHeight+r,D,v);o.style.height=`${a}px`,n.currentHeight=a}else{let r=Math.floor(n.startX-t.clientX);r=n.direction&s.east?-r:r;const a=$(n.startWidth+r,c,b);o.style.width=`${a}px`,n.currentWidth=a}},O=()=>{const t=S.current,o=y.current,n=j.current;if(t!==null&&n!==null&&o.isResizing){const N=o.currentWidth,h=o.currentHeight;o.startWidth=0,o.startHeight=0,o.ratio=0,o.startX=0,o.startY=0,o.currentWidth=0,o.currentHeight=0,o.isResizing=!1,n.classList.remove("image-control-wrapper--resizing"),I(),R(N,h),document.removeEventListener("pointermove",_),document.removeEventListener("pointerup",O)}};return e.jsxs("div",{ref:j,children:[!w&&L&&e.jsx("button",{className:"image-caption-button",ref:u,onClick:()=>{M(!w)},children:"Add Caption"}),e.jsx("div",{className:"image-resizer image-resizer-n",onPointerDown:t=>{p(t,s.north)}}),e.jsx("div",{className:"image-resizer image-resizer-ne",onPointerDown:t=>{p(t,s.north|s.east)}}),e.jsx("div",{className:"image-resizer image-resizer-e",onPointerDown:t=>{p(t,s.east)}}),e.jsx("div",{className:"image-resizer image-resizer-se",onPointerDown:t=>{p(t,s.south|s.east)}}),e.jsx("div",{className:"image-resizer image-resizer-s",onPointerDown:t=>{p(t,s.south)}}),e.jsx("div",{className:"image-resizer image-resizer-sw",onPointerDown:t=>{p(t,s.south|s.west)}}),e.jsx("div",{className:"image-resizer image-resizer-w",onPointerDown:t=>{p(t,s.west)}}),e.jsx("div",{className:"image-resizer image-resizer-nw",onPointerDown:t=>{p(t,s.north|s.west)}})]})}const k=new Set;function oe(m){if(!k.has(m))throw new Promise(R=>{const u=new Image;u.src=m,u.onload=()=>{k.add(m),R(null)}})}function re({altText:m,className:R,imageRef:u,src:S,width:x,height:C,position:w}){return oe(S),e.jsx("img",{className:R||void 0,src:S,alt:m,ref:u,"data-position":w,style:{display:"block",height:C,width:x},draggable:"false"})}function ae({activeEditor:m,nodeKey:R,onClose:u}){const x=m.getEditorState().read(()=>i.$getNodeByKey(R)),[C,w]=g.useState(x.getAltText()),[M,L]=g.useState(x.getShowCaption()),[j,E]=g.useState(x.getPosition()),y=v=>{L(v.target.checked)},l=v=>{E(v.target.value)},b=()=>{const v={altText:C,position:j,showCaption:M};x&&m.update(()=>{x.update(v)}),u()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:"1em"},children:e.jsx(ee,{label:"Alt Text",placeholder:"Descriptive alternative text",onChange:w,value:C,"data-test-id":"image-modal-alt-text-input"})}),e.jsxs(te,{style:{marginBottom:"1em",width:"208px"},value:j,label:"Position",name:"position",id:"position-select",onChange:l,children:[e.jsx("option",{value:"left",children:"Left"}),e.jsx("option",{value:"right",children:"Right"}),e.jsx("option",{value:"full",children:"Full Width"})]}),e.jsxs("div",{className:"Input__wrapper",children:[e.jsx("input",{id:"caption",type:"checkbox",checked:M,onChange:y}),e.jsx("label",{htmlFor:"caption",children:"Show Caption"})]}),e.jsx(ne,{children:e.jsx(se,{"data-test-id":"image-modal-file-upload-btn",onClick:()=>b(),children:"Confirm"})})]})}function de({src:m,altText:R,nodeKey:u,width:S,height:x,showCaption:C,caption:w,position:M}){const[L,j]=G(),E=g.useRef(null),y=g.useRef(null),[l,b,v]=Y.useLexicalNodeSelection(u),[c]=H.useLexicalComposerContext(),[D,W]=g.useState(null),I=g.useRef(null),[p,_]=g.useState(!1),[O,t]=g.useState(!1),o=g.useCallback(f=>{if(l&&i.$isNodeSelection(i.$getSelection())){f.preventDefault();const d=i.$getNodeByKey(u);T(d)&&d.remove()}return!1},[l,u]),n=g.useCallback(f=>{const P=i.$getSelection(),d=y.current;if(l&&i.$isNodeSelection(P)&&P.getNodes().length===1){if(C)return i.$setSelection(null),f.preventDefault(),w.focus(),!0;if(d!==null&&d!==document.activeElement)return f.preventDefault(),d.focus(),!0}return!1},[w,l,C]),N=g.useCallback(f=>I.current===w||y.current===f.target?(i.$setSelection(null),c.update(()=>{b(!0);const P=c.getRootElement();P!==null&&P.focus()}),!0):!1,[w,c,b]);g.useEffect(()=>{let f=!0;const P=B.mergeRegister(c.registerUpdateListener(({editorState:d})=>{f&&W(d.read(()=>i.$getSelection()))}),c.registerCommand(i.SELECTION_CHANGE_COMMAND,(d,A)=>(I.current=A,!1),i.COMMAND_PRIORITY_LOW),c.registerCommand(i.CLICK_COMMAND,d=>{const A=d;return p?!0:A.target===E.current?(A.shiftKey?b(!l):(v(),b(!0)),!0):!1},i.COMMAND_PRIORITY_LOW),c.registerCommand(i.DRAGSTART_COMMAND,d=>d.target===E.current?(d.preventDefault(),!0):!1,i.COMMAND_PRIORITY_LOW),c.registerCommand(i.KEY_DELETE_COMMAND,o,i.COMMAND_PRIORITY_LOW),c.registerCommand(i.KEY_BACKSPACE_COMMAND,o,i.COMMAND_PRIORITY_LOW),c.registerCommand(i.KEY_ENTER_COMMAND,n,i.COMMAND_PRIORITY_LOW),c.registerCommand(i.KEY_ESCAPE_COMMAND,N,i.COMMAND_PRIORITY_LOW));return()=>{f=!1,P()}},[v,c,l,u,o,p,n,N,b]);const h=(f,P)=>{setTimeout(()=>{_(!1)},200),c.update(()=>{const d=i.$getNodeByKey(u);T(d)&&d.setWidthAndHeight(f,P)})},r=()=>{_(!0)},a=l&&i.$isNodeSelection(D)&&!p,z=l||p;return e.jsxs(g.Suspense,{fallback:null,children:[e.jsxs(e.Fragment,{children:[e.jsxs("div",{draggable:a,children:[e.jsx("button",{className:"image-edit-button",ref:y,onClick:()=>{j("Update Inline Image",f=>e.jsx(ae,{activeEditor:c,nodeKey:u,onClose:f}))},children:"Edit"}),e.jsx(re,{className:z?`focused ${i.$isNodeSelection(D)?"draggable":""}`:null,src:m,altText:R,imageRef:E,width:S,height:x,position:M})]}),C&&e.jsx("div",{className:"image-caption-container",children:e.jsxs(U.LexicalNestedComposer,{initialEditor:w,children:[e.jsx(F.AutoFocusPlugin,{}),e.jsx(V,{}),e.jsx(J,{isLinkEditMode:O,setIsLinkEditMode:t}),e.jsx(q,{}),e.jsx(X.RichTextPlugin,{contentEditable:e.jsx(Q,{className:"min-h-[20px] border-[0px] resize-none cursor-text block relative [tab-size:1] outline-[0px] p-[10px] select-text text-[14px] leading-[1.4em] w-[calc(100% - 20px)] whitespace-pre-wrap"}),placeholder:e.jsx(Z,{className:"text-[12px] text-[#888] overflow-hidden absolute overflow-ellipsis bottom-[10px] left-[10px] select-none whitespace-nowrap inline-block pointer-events-none",children:"Enter a caption..."}),ErrorBoundary:K})]})}),i.$isNodeSelection(D)&&z&&e.jsx(ie,{showCaption:C,setShowCaption:()=>{},editor:c,buttonRef:y,imageRef:E,maxWidth:1080,onResizeStart:r,onResizeEnd:h,captionsEnabled:!1})]}),L]})}export{ae as UpdateInlineImageDialog,de as default};
